{% if review %}
<div class="border-bottom pb-3 mb-3
    {% if review.user == recipe.author %}review-author{% endif %}"
    style="{% if review.parent %}margin-left: 20px;{% endif %}">

    <div class="review">
        <div class="review-avatar" title="{{ review.user.username }}">
            {{ review.user.username|first|upper }}
        </div>

        <div class="review-body">
            <div class="review-header">
                {{ review.user.username }}

                {% if review.user == recipe.author %}
                    <span class="badge author-badge">Auteur</span>
                {% endif %}

                {% if not review.parent %}
                    <span class="text-warning">⭐ {{ review.rating }}/5</span>
                {% endif %}
            </div>

            <p class="review-text">{{ review.comment }}</p>
            <small class="text-muted">{{ review.created_at|date:"d/m/Y H:i" }}</small>

            <div class="review-actions mt-2">
                {% if user.is_authenticated and user == recipe.author %}
                    <a href="{% url 'delete_review' review.id %}"
                       class="text-danger"
                       onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce commentaire ?');">
                       Supprimer
                    </a>
                {% endif %}

                {% if user.is_authenticated %}
                    <button class="btn btn-link p-0" onclick="toggleReplyForm('{{ review.id }}')">
                        Répondre
                    </button>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="reply-form" id="reply-form-{{ review.id }}" style="display: none;">
        <form method="POST" action="{% url 'recipe_detail' recipe.id %}#comments">
            {% csrf_token %}
            <input type="hidden" name="parent_id" value="{{ review.id }}">
            <div class="mb-2">
                <textarea name="comment" rows="3" class="form-control form-control-sm"
                          placeholder="Écrivez votre réponse..."
                          required id="id_comment_{{ review.id }}"></textarea>
            </div>

            <button type="submit" class="btn btn-orange btn-sm">Envoyer la réponse</button>
        </form>
    </div>

    <div class="replies-container mt-3">
        {% for reply in review.replies.all %}
            {% include "partials/_review.html" with review=reply recipe=recipe %}
        {% endfor %}
    </div>
</div>
{% endif %}


<script>
    // Assure que la fonction existe, même si elle est déjà chargée
    if (typeof toggleReplyForm === 'undefined') {
        function toggleReplyForm(reviewId) {
            var form = document.getElementById('reply-form-' + reviewId);
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }
    }
</script>