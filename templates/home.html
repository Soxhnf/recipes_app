{% extends 'base.html' %}
{% load static %}

{% block title %}Accueil - {% endblock %}

{% block extra_head %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Police --- */
        body, .btn, .form-control, .form-select, .card-title, .nav-link, .navbar-brand, .dropdown-item {
            font-family: 'Manrope', sans-serif;
        }

        /* --- Barre de Filtre Fixe --- */
        .sticky-top-filters {
            position: sticky; top: 0; z-index: 1020;
            background-color: #f8f9fa; padding-top: 1.5rem;
            padding-bottom: 1rem; margin-bottom: 2.5rem;
        }

        .filter-bar-custom {
            padding: 0; background-color: transparent;
            border: none; box-shadow: none;
        }

        /* --- Styles de la Barre de Recherche (Icône à l'intérieur) --- */
        .search-bar-wrapper {
            position: relative; /* Conteneur pour l'icône */
        }
        .search-icon {
            position: absolute;
            top: 50%;
            left: 1.5rem; /* Ajustez pour le bon espacement */
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 10;
            font-size: 1rem;
        }

        .filter-bar-custom .form-control {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            height: 50px;
            font-size: 1rem;
            border-radius: 50px;
            padding-left: 3.5rem; /* Espace pour l'icône à l'intérieur */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .filter-bar-custom .form-control:focus {
            border-color: #fd7e14;
            box-shadow: 0 0 0 3px rgba(253, 126, 20, 0.2);
        }

        /* --- Styles pour les filtres de droite --- */
        .custom-dropdown-toggle,
        .filter-bar-custom .fav-btn {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            height: 50px;
            font-size: 1rem;
            border-radius: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        /* Style pour le bouton désactivé */
        .custom-dropdown-toggle:disabled {
            background-color: #e9ecef; /* Fond gris */
            opacity: 0.7;
            pointer-events: none; /* Empêche le clic */
        }

        .custom-dropdown-toggle {
            padding: 0 1.5rem;
            gap: 0.5rem;
            color: #212529;
            font-weight: 400;
            min-width: 200px;
        }

        .custom-dropdown-menu {
            border-radius: 1rem; border: 1px solid #dee2e6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 0.5rem;
            width: 100%;
        }
        .custom-dropdown-menu .dropdown-item {
            border-radius: 0.75rem; padding: 0.5rem 1rem; font-weight: 500;
        }
        .custom-dropdown-menu .dropdown-item:hover,
        .custom-dropdown-menu .dropdown-item:focus,
        .custom-dropdown-menu .dropdown-item.active {
            background-color: #fff7ed; color: #fd7e14;
        }

        .filter-bar-custom .fav-btn {
            padding: 0 1.25rem;
            gap: 0.5rem;
            color: #fd7e14;
            border-color: #fd7e14;
        }
        .filter-bar-custom .fav-btn .bi-heart-fill {
            font-size: 1.1rem;
            color: #fd7e14;
        }

        .custom-dropdown-toggle:hover,
        .filter-bar-custom .fav-btn:hover {
            background-color: #fd7e14;
            border-color: #fd7e14;
            color: #ffffff;
        }
        .filter-bar-custom .fav-btn:hover .bi-heart-fill {
            color: #ffffff;
        }
        .custom-dropdown-toggle:hover::after {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffffff'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
        }

        /* --- Styles des Cartes de Recettes --- */
        .recipe-card {
            border-radius: 1rem; overflow: hidden; border: 1px solid #f3f4f6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            transition: box-shadow 0.3s ease-in-out;
            background-color: #ffffff;
        }
        .recipe-card:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.08); }
        .recipe-card-img-wrapper { height: 200px; overflow: hidden; position: relative; background-color: #e9ecef; }
        .recipe-card-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease-in-out; }
        .recipe-card:hover .recipe-card-img { transform: scale(1.08); }
        .favorite-btn {
            position: absolute; top: 0.8rem; right: 0.8rem;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            padding: 0; border: none; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s ease-in-out; cursor: pointer; z-index: 10;
        }
        .favorite-btn i { font-size: 1.1rem; color: #6c757d; line-height: 1; transition: color 0.2s ease-in-out; }
        .favorite-btn:hover { transform: scale(1.1); }
        .favorite-btn:hover .bi-heart { color: #fd7e14; }
        .favorite-btn:hover .bi-heart-fill { color: #fd7e14; }
        .favorite-btn.favorited .bi-heart-fill { display: block; color: #fd7e14; }
        .favorite-btn.favorited .bi-heart { display: none; }
        .favorite-btn .bi-heart-fill { display: none; }
        .favorite-btn .bi-heart { display: block; }
        .recipe-card .card-body { padding: 1rem 1.25rem 1.25rem; }
        .recipe-card .card-title {
            font-size: 1.25rem; font-weight: 600; margin-bottom: 0.75rem;
            color: #212529; text-decoration: none;
        }
        .recipe-card .card-title:hover { color: #fd7e14; }
        .recipe-meta-text {
            display: flex; flex-wrap: wrap; align-items: center;
            gap: 0.25rem 0.5rem; font-size: 0.9rem; color: #6c757d;
        }
        .recipe-meta-text .category-tag {
            color: #fd7e14; font-weight: 500;
            background-color: #fff7ed; padding: 0.25rem 0.6rem; border-radius: 6px;
        }
        .recipe-meta-text .rating-stars { color: #fd7e14; }
        .recipe-meta-text .dot-separator { color: #adb5bd; }

        .empty-results-card {
            background-color: #ffffff; border: 1px solid #f3f4f6;
            border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            padding: 3rem 2rem; text-align: center;
        }
        .empty-results-card h4 { font-weight: 600; color: #212529; }
        .empty-results-card p { font-size: 1.1rem; color: #6c757d; }
        .empty-results-card a { color: #fd7e14; font-weight: 500; text-decoration: none; }
        .empty-results-card a:hover { text-decoration: underline; }
    </style>
{% endblock %}

{% block content %}

<div class="sticky-top-filters">
    <form method="GET" action="{% url 'home' %}" id="filter-form" class="row g-3 align-items-center filter-bar-custom">
        {% csrf_token %}
        <div class="col-lg-1 d-none d-lg-block"></div>

        <div class="col-lg-5 col">
            <div class="search-bar-wrapper">
                <i class="bi bi-search search-icon"></i>
                <input type="text" name="ingredient" class="form-control"
                       placeholder="Rechercher des recettes..."
                       value="{{ selected_ingredient|default:'' }}"
                       id="search-input">
            </div>
        </div>

        <div class="col-auto ms-auto">
            <div class="dropdown">
                <button class="btn custom-dropdown-toggle dropdown-toggle" type="button"
                        data-bs-toggle="dropdown" aria-expanded="false"
                        id="category-dropdown-btn">
                    {{ selected_category|default:"All Categories" }}
                </button>
                <ul class="dropdown-menu custom-dropdown-menu">
                    <li><a class="dropdown-item {% if not selected_category %}active{% endif %}" href="#" data-value="">All Categories</a></li>
                    {% for category in categories %}
                    <li><a class="dropdown-item {% if selected_category == category.name %}active{% endif %}" href="#" data-value="{{ category.name }}">{{ category.name }}</a></li>
                    {% endfor %}
                </ul>
                <select name="category" id="real-category-select" class="d-none">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category.name }}" {% if selected_category == category.name %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        {% if user.is_authenticated %}
        <div class="col-auto">
            <input type="checkbox" class="btn-check" name="favorites" value="true" id="fav-filter"
                   {% if request.GET.favorites %}checked{% endif %}>
            <label class="btn fav-btn" for="fav-filter">
                <i class="bi bi-heart-fill"></i>
                <span>{{ favorites_count|default:"0" }}</span>
            </label>
        </div>
        {% endif %}

        <div class="col-lg-1 d-none d-lg-block"></div>
    </form>
</div>

<div id="recipe-grid-container">
    {% include "partials/_recipe_grid.html" with recipes=recipes api_recipes=api_recipes user=user %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        let debounceTimer;
        const form = document.getElementById('filter-form');
        const gridContainer = document.getElementById('recipe-grid-container');
        const searchInput = document.getElementById('search-input');
        const favFilter = document.getElementById('fav-filter');
        const favoritesCounter = document.querySelector('.fav-btn span');
        const categoryBtn = document.getElementById('category-dropdown-btn');
        const realSelect = document.getElementById('real-category-select');
        const fakeDropdownItems = document.querySelectorAll('.custom-dropdown-menu .dropdown-item');

        // --- NOUVELLE FONCTION AJAX PRINCIPALE ---
        function performSearch() {
            const formData = new FormData(form);
            const params = new URLSearchParams(formData);

            if (!formData.has('favorites')) {
                params.delete('favorites');
            }
            const searchUrl = `/?${params.toString()}`;

            fetch(searchUrl, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json()) // On s'attend à du JSON
            .then(data => {
                // 1. Met à jour la grille avec le HTML du JSON
                gridContainer.innerHTML = data.html;

                // 2. Met à jour le compteur avec la valeur du JSON
                if (favoritesCounter) {
                    favoritesCounter.textContent = data.favorites_count;
                }

                // 3. Ré-attache les écouteurs de clic
                attachFavoriteListeners();

                // 4. VÉRIFIE L'ÉTAT DU BOUTON (maintenant que tout est à jour)
                updateCategoryFilterState();
            })
            .catch(error => console.error('Erreur de recherche AJAX:', error));
        }

        // --- FONCTION pour l'état du bouton ---
        function updateCategoryFilterState() {
            // S'assure que tout existe
            if (!favFilter || !favoritesCounter || !categoryBtn) return;

            const isFavFilterActive = favFilter.checked;
            // Lit la valeur (qui vient d'être mise à jour)
            const currentFavCount = parseInt(favoritesCounter.textContent, 10);

            // Désactive si le filtre est coché ET que le compte est à 0
            if (isFavFilterActive && currentFavCount === 0) {
                categoryBtn.disabled = true;
            } else {
                categoryBtn.disabled = false;
            }
        }

        // --- Écouteurs d'événements ---
        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(performSearch, 500);
            });
        }

        fakeDropdownItems.forEach(function(item) {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                realSelect.value = this.dataset.value;
                performSearch();
            });
        });

        if (favFilter) {
            favFilter.addEventListener('change', function() {
                // L'appel à updateCategoryFilterState() est
                // géré par la fonction performSearch()
                performSearch();
            });
        }

        // --- Logique de favoris (clic sur le cœur) ---
        function attachFavoriteListeners() {
            document.querySelectorAll('.favorite-btn').forEach(button => {
                if (button.dataset.listenerAttached) return;

                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.dataset.listenerAttached = 'true';

                    const recipeId = this.dataset.recipeId;
                    const icon = this;
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    fetch(`/toggle_favorite/${recipeId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'ok') {
                            if (data.is_favorited) {
                                icon.classList.add('favorited');
                            } else {
                                icon.classList.remove('favorited');
                            }
                            if (favoritesCounter) {
                                favoritesCounter.textContent = data.favorites_count;
                            }
                            // Met aussi à jour l'état du bouton
                            updateCategoryFilterState();
                        }
                    })
                    .catch(error => console.error('Erreur Fetch favori:', error));
                });
            });
        }

        // --- Appels initiaux au chargement ---
        attachFavoriteListeners();
        updateCategoryFilterState();

    });
</script>

{% endblock %}